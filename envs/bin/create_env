#!/bin/bash

echoerr() { echo "Error: $@" 1>&2; }

# get python3 path
PYTHON=$(which python3)

# calculate environment directory
# from the current one
CURRENT_FILE=$($PYTHON -c "import os; print(os.path.realpath('${BASH_SOURCE[0]}'))")
BIN_DIR=$(dirname ${CURRENT_FILE})
BASE_ENV=$(dirname ${BIN_DIR})/reflow

# check virtualenv is installed
# otherwise install it to prevent environment polution
HAS_VIRT_ENV=$($PYTHON -m pip list | grep virtualenv)

if [ -z "${HAS_VIRT_ENV}" ]; then
    echo "Warning: virtualenv is required"
    $PYTHON -m pip install pip --upgrade
    $PYTHON -m pip install virtualenv
fi

# check the environment does not already exist
if [[ -d ${BASE_ENV} ]]; then
    echoerr "Error: the environment already exist"
    echoerr "please remove it before creating it"
    exit
fi

# create the environment
$PYTHON -m virtualenv "${BASE_ENV}"
# install modules
source ${BASE_ENV}/bin/activate
pip install -r $(dirname ${CURRENT_FILE})/requirements.txt

# add REFLOW env variable
# Add base path of ReFlow
REFLOW=$(dirname $(dirname ${BASE_ENV}))
# add for bash based env
echo "# Add base path of ReFlow" >> ${BASE_ENV}/bin/activate
echo "export REFLOW=${REFLOW}" >> ${BASE_ENV}/bin/activate
echo "export PATH=${BIN_DIR}:\${PATH}" >> ${BASE_ENV}/bin/activate
# add for csh based env
sed -i 's/rehash//' ${BASE_ENV}/bin/activate.csh
echo "# Add base path of ReFlow" >> ${BASE_ENV}/bin/activate.csh
echo "setenv REFLOW=${REFLOW}" >> ${BASE_ENV}/bin/activate.csh
echo "setenv PATH=${BIN_DIR}:\${PATH}" >> ${BASE_ENV}/bin/activate.csh
echo "rehash" >> ${BASE_ENV}/bin/activate.csh
# add for python
echo "# Add base path of ReFlow" >> ${BASE_ENV}/bin/activate_this.py
echo "os.environ[\"REFLOW\"] = \"${REFLOW}\"" >> ${BASE_ENV}/bin/activate_this.py
echo "sys.path.append(\"${BIN_DIR}\")" >> ${BASE_ENV}/bin/activate_this.py