#!/usr/bin/env python3
# coding: utf-8

import os
import sys
import doit

from enum import Enum
from pathlib import Path

# assume the run utility is placed in the envs/bin/ directory
ENVBIN_DIR = os.path.dirname(os.path.realpath(__file__))
# current execution path
CURRENT_DIR = os.getcwd()
# define the path where is stored the flow
REFLOW_DIR = os.environ["REFLOW"]
sys.path.append(REFLOW_DIR)
sys.path.append(CURRENT_DIR)

import common.utils as utils
import common.utils.doit as doit_helper

import common.relog as relog
import common.design_tree as design_tree
import common.read_sources as read_sources

from common.read_config import Config, locate_config_files


class SimType(Enum):
    DIGITAL = "dig"
    ANALOG = "ana"
    MIXED = "mix"


def create_working_dir(suffix: str):
    # define working directory
    os.environ["WORK_DIR"] = utils.normpath(
        os.path.join(CURRENT_DIR, utils.get_tmp_folder_name(suffix, "./"))
    )
    os.makedirs(os.environ["WORK_DIR"], exist_ok=True)


def get_context(use_custom_logger: bool = False):
    # list files and mime types
    files, params = read_sources.read_from(CURRENT_DIR, no_logger=True)
    # determine the type of simulation
    digital_only = all((utils.files.is_digital(file) for file, _ in files))
    analog_only = all((utils.files.is_analog(file) for file, _ in files))
    if digital_only and not use_custom_logger:
        files.insert(
            0,
            (
                utils.normpath(os.path.join(REFLOW_DIR, "digital/packages/log.svh")),
                "SYSTEM_VERILOG",
            ),
        )
    sim_type = (
        SimType.DIGITAL
        if digital_only
        else SimType.ANALOG
        if analog_only
        else SimType.MIXED
    )
    return (sim_type, files, params)


def load_config():
    global CURRENT_DIR
    # normalize execution path
    CURRENT_DIR = utils.normpath(CURRENT_DIR)
    # the default configuration
    default_config = utils.normpath(os.path.join(REFLOW_DIR, "./default.config"))
    # load a local configuration if there is one
    config_files = [default_config] + locate_config_files(CURRENT_DIR)
    if len(config_files) == 1:
        relog.info("No config file found. Fallback on the default")
    # load the configuration
    Config.read_configs(config_files)
    Config.set_env({"TECH_LIB": "technology.TECH_LIB", "PLATFORM": "reflow.PLATFORM"})


def load_tools():
    # get a list of all tools to be loaded for all context
    context = {}
    for id_tool in Config.tools:
        ctx = id_tool[:3]
        tool_name = Config.tools.get(id_tool)
        if ctx in context:
            context[ctx].append(tool_name)
        else:
            context[ctx] = [tool_name]
    # ensure unicity of tool loading per context
    for ctx in context:
        context[ctx] = list(set(context[ctx]))
    # determine the context
    ctx, files, params = get_context()
    # load all tools
    for tool_name in context[ctx.value]:
        # find the tool
        tool_path = utils.tools.find_tool(tool_name)
        sys.path.append(os.path.dirname(tool_path))
        # load it and its config
        tool = utils.tools.import_module(tool_name)
        for name in dir(tool):
            if name.startswith("task"):
                globals()[name] = getattr(tool, name)
        # read config files
        for conf in Path(tool_path).rglob("*.config"):
            Config.add_configs(conf)


def task_tree():
    """
    display hierarchy of the design
    """

    def tree(task):
        files, params = read_sources.read_from(os.getcwd(), no_logger=False)
        design_tree.main(files, params)

    return {"actions": [tree], "title": doit_helper.task_name_as_title, "verbosity": 2}


if __name__ == "__main__":
    # load selected tools
    load_config()
    load_tools()

    DOIT_CONFIG = doit_helper.DOIT_CONFIG
    doit_helper.TaskNumber.ENVS = globals()

    # execute task selected
    doit.run(globals())
